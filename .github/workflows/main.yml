name: Build & Deploy Next.js
on:
  push:
    branches:
      - main
    paths:
      - '**'
  workflow_dispatch:

jobs:
  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # disarankan 20 karena beberapa package butuh >=20

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build application
        run: npm run build

      - name: ğŸ“‹ Prepare build artifacts
        run: |
          mkdir -p build-output
          cp -r .next build-output/
          cp package.json build-output/
          cp next.config.* build-output/ 2>/dev/null || true
          echo "Build completed at $(date)" > build-output/build-info.txt

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: build-output/
          retention-days: 7

  deploy:
    name: ğŸš€ Deploy to Server
    needs: build
    runs-on: [self-hosted, deploy]  # sesuai label runner kamu

    steps:
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: ${{ runner.temp }}/nextjs-build

      - name: ğŸ§¾ List downloaded files
        shell: powershell
        run: |
          Write-Host "Downloaded build artifacts:"
          Get-ChildItem -Path "$env:RUNNER_TEMP\nextjs-build" -Recurse | Select-Object FullName

      - name: ğŸšš Copy build to app directory
        shell: powershell
        run: |
          $target = "C:\emkl-next"  # ubah sesuai path app kamu
          Write-Host "Copying build files to $target ..."
          Copy-Item -Path "$env:RUNNER_TEMP\nextjs-build\*" -Destination $target -Recurse -Force

      - name: ğŸ” Restart app with PM2
        shell: powershell
        run: |
          pm2 restart emkl-next || pm2 start C:\emkl-next\server.js --name emkl-next

      - name: âœ… Done
        run: echo "Deployment finished successfully!"
