name: Build & Deploy Next.js
on:
  push:
    branches:
      - main
    paths:
      - 'emkl-next/**'
  workflow_dispatch:

jobs:
  build:
    name: Build Next.js
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Hapus cache jika bermasalah
          # cache: 'npm'
          # cache-dependency-path: emkl-next/package-lock.json
      
      - name: ðŸ“¦ Install dependencies
        working-directory: ./emkl-next
        run: npm ci
      
      - name: ðŸ”¨ Build application
        working-directory: ./emkl-next
        run: npm run build
      
      - name: ðŸ“‹ Prepare artifacts
        working-directory: ./emkl-next
        run: |
          mkdir -p ../build-output
          cp -r .next ../build-output/
          cp package.json ../build-output/
          cp package-lock.json ../build-output/
          if [ -f next.config.js ]; then cp next.config.js ../build-output/; fi
          if [ -f next.config.mjs ]; then cp next.config.mjs ../build-output/; fi
          echo "Build completed at $(date)" > ../build-output/build-info.txt
          
      - name: ðŸ“¤ Upload build
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: build-output/
          retention-days: 7

  deploy:
    name: Deploy Next.js
    needs: build
    runs-on: [self-hosted, deploy]
    
    steps:
      - name: ðŸ“¥ Download build
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: ${{ runner.temp }}/nextjs-build
      
      - name: ðŸ“‹ Verify download
        shell: powershell
        run: |
          Write-Host "==================================="
          Write-Host "Build artifacts downloaded to:"
          Write-Host "$env:RUNNER_TEMP\nextjs-build"
          Write-Host "==================================="
          Get-ChildItem -Path "$env:RUNNER_TEMP\nextjs-build" -Recurse | Select-Object FullName
      
      - name: ðŸš€ Deploy
        shell: cmd
        run: C:\apps\scripts\deploy-nextjs.bat
      
      - name: ðŸ§¹ Cleanup
        shell: powershell
        run: |
          Remove-Item -Path "$env:RUNNER_TEMP\nextjs-build" -Recurse -Force -ErrorAction SilentlyContinue
      
      - name: âœ… Complete
        run: echo "Next.js deployed successfully!"
